---
title: "mSigHdp vignette"
author: "ML, YW, NJ and SGR"
date: "06/01/2022"
output:
  html_document: default
---

How to use mSigHdp to discover mutational signatures (Liu et al., 2021)

```{r ,eval=F}
devtools::install_github("steverozen/mSigHdp",ref="master")
```

```{r load_library}
library(mSigHdp)
```

### Extract signatures by RunHdpxParallel

To illustrate the basic features of the mSigHdp package, we consider a toy data set
of categorical count data with **10 samples** (columns) and **96 categories** (rows). 
The **10 samples** are PCAWG platinum tumors. The data is stored in data-raw folder

```{r toydata}
toy_data <- ICAMS::ReadCatalog("toy_data.csv")

head(toy_data)
```

We set the _num.child.process_ and _CPU.cores_ to 4 for a quick run. We recommend _num.child.process_ and _CPU.cores_ set to 20 for real data.
There are three checkpoint arguments: _checkpoint.chlist_ to checkpoint the chlist to "initial.chlist.Rdata" in the current working directory. _checkpoint.1.chain_ to checkpoint the sample chain to current working directory, _posterior.checkpoint_ to checkpoint the posterior sampling after every 10 posterior samples collected. We also provided functions to continue burn-in and Gibbs sampling from checkpoints, in case of possible interruption during running long jobs. 
Please refer to the documentations of ExtendBurnin function in mSigHdp package and hdp_posterior_sample function in hdpx package.

```{r RunHdpxParallel,include=T,echo=T,warning=F,message=F,error=F,results='hide'}

retval <- mSigHdp::RunHdpxParallel(
  input.catalog = toy_data,
  out.dir                  = "results_from_vignettes/",
  num.child.process        = 4, 
  CPU.cores                = 4,
  seedNumber               = 123,
  K.guess                  = 5,
  burnin.checkpoint        = T,
  burnin                   = 100,
  burnin.multiplier        = 2,
  post.n                   = 20, 
  post.space               = 10, 
  multi.types              = TRUE, 
  overwrite                = TRUE,
  gamma.alpha              = 1,
  gamma.beta               = 20, 
  high.confidence.prop     = 0.9,
  checkpoint.chlist        = FALSE,
  checkpoint.1.chain       = FALSE,
  posterior.checkpoint     = FALSE) 

```



### Results

There are several outputs in the out.dir (in this vignettes, we saved outputs to data-raw/vignettes/results_from_vignettes)

- **extracted.signatures.csv** and **extracted.signatures.pdf**

These two files are profiles and visualization of extracted signatures.

- **extracted.signatures.post.samp.number.csv**

A csv file with two columns. The first column contains the signature names correspond to extracted.signatures.csv, the second column contains the number of posterior samples extracted the corresponding signature.

- **inferred.exposures.csv**

Exposures inferred from HDP. Because there is no sparsity constraint of assignment in HDP. We recommend to use a signature assignment program to re-analyze the exposure, e.g. mSigAct, MutationalPatterns..

- **inferred.exposure.count.pdf and inferred.exposure.proportion.pdf**

Barplots of the counts and exposures of extracted signatures in each tumor.

- **low.confidence.signatures.csv** 

The profiles of extracted signatures with low confidence (i.e. the proportion of posterior samples with these signatures is less than pre-defined high.confidence.prop in RunHdpxParallel).

- **low.confidence.signatures.post.sample.number.csv** 

A csv file with two columns. The first column contains the signature names correspond to low.confidence.signatures.csv, the second column contains the number of posterior samples extracted the corresponding signature.

- **Diagnostic_Plots** folder contains five diagnostic plots:

- **diagnostics_likelihood.pdf**. To check if the likelihood is converged for each chain.

```{r Diagnostic likelihood plot,out.width = "50%",echo=F}
knitr::include_graphics("results_from_vignettes/Diagnostic_Plots/diagnostics_likelihood.pdf")

```

- **diagnostics_numcluster.pdf**. To show the number of clusters in each posterior sample.

```{r Diagnostic number of clusters plot,out.width = "50%",echo=F}
knitr::include_graphics("results_from_vignettes/Diagnostic_Plots/diagnostics_numcluster.pdf")

```

- **diagnostics_signatures.pdf**. To show the 95\% CI of each category of extracted signatures.

```{r Diagnostic signatures plot,out.width = "50%",echo=F}
knitr::include_graphics("results_from_vignettes/Diagnostic_Plots/diagnostics_signatures.pdf")

```

- **diagnostics_component_distribution_in_posterior_samples.pdf**. To show the posterior samples that 
contribute to the aggregation of every extracted signature.

```{r Diagnostic extraction in gibbs sampling plot,out.width = "50%",echo=F}
knitr::include_graphics("results_from_vignettes/Diagnostic_Plots/diagnostics_component_distribution_in_posterior_samples.pdf")

```

- **diagnostics_hdp_signature_exposure_each_sample.pdf**. Every extracted signature has two plots: (1) the scatter plots shows the proportion and counts of each signature in every tumor. (2) the 5 tumors with the highest proportion of this signature.

```{r Diagnostic example tumors for each signature plot,out.width = "50%",echo=F}
knitr::include_graphics("results_from_vignettes/Diagnostic_Plots/diagnostics_hdp_signature_exposure_each_sample.pdf")

```


# Session info

Session information for the system on which this document was compiled:

```{r sessionInfo}
devtools::session_info()
```
